<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>401实验室 · 图像处理</title>
    <!-- 全新阳光主题，仅此一个样式入口 -->
    <link rel="stylesheet" href="/css_files/sunny.css" />
    <link rel="icon" href="/assets/logo.png" type="image/x-icon" />
    <link rel="shortcut icon" href="/assets/logo.png" type="image/x-icon" />
</head>
<body>
    <main class="page">
        <section class="hero">
            <div class="hero-mark">401 LAB</div>
            <h1 class="hero-title">图像处理实验台</h1>
        </section>
        <div class="two-cols">
            <section id="upload" class="card">
                <div class="card-header">上传与处理</div>
                <div class="card-body">
                    <form id="upload-form" method="POST" enctype="multipart/form-data">
                        <div class="file-input-container">
                            <input type="file" id="image-input" name="image" accept="image/*" required />
                            <label for="image-input" class="button accent">选择图片</label>
                            <span id="file-name" class="file-name">未选择文件</span>
                        </div>

                        <div class="image-preview-container">
                            <img id="image-preview" src="#" alt="预览图片" style="display: none;" />
                        </div>

                        <button type="submit" class="button primary">上传图片</button>
                    </form>

                    <div id="upload-status" class="status"></div>
                </div>
            </section>

            <section id="result" class="card">
                <div class="card-header">处理结果</div>
                <div class="card-body">
                    <div id="result-status" class="status"></div>
                    <pre id="result-content" class="result-content" style="white-space: pre-wrap; background:#fffaf0; padding:12px; border:1px solid var(--border); border-radius:10px; min-height:160px;">
                    </pre>
                </div>
            </section>
        </div>
    </main>

    <script>
        // 全局变量存储当前上传的图片信息
        let currentUploadedImage = null;

        // 图片预览
        document.getElementById('image-input').addEventListener('change', function(event) {
            const fileInput = event.target;
            const fileNameSpan = document.getElementById('file-name');
            const imagePreview = document.getElementById('image-preview');

            if (fileInput.files && fileInput.files[0]) {
                const fileName = fileInput.files[0].name;
                fileNameSpan.textContent = fileName;

                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                fileNameSpan.textContent = '未选择文件';
                imagePreview.style.display = 'none';
            }
        });

        // 上传提交
        document.getElementById('upload-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const statusDiv = document.getElementById('upload-status');
            const resultStatus = document.getElementById('result-status');
            const resultContent = document.getElementById('result-content');

            statusDiv.innerHTML = '<p class="status-message loading">正在上传图片，请稍候...</p>';
            resultStatus.innerHTML = '';
            resultContent.textContent = '';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`服务器响应错误: ${response.status} ${response.statusText}`);
                }
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        throw new Error(`服务器未返回JSON (${contentType}): ${text.substring(0, 150)}...`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `<p class="status-message success">图片上传成功！</p>
                                           <p class="status-line">图片URL: <a href="${data.url}" target="_blank">${data.url}</a></p>`;
                    currentUploadedImage = { url: data.url, filename: data.filename };
                    // 开始轮询结果
                    startPollingResult(data.filename);
                } else {
                    statusDiv.innerHTML = `<p class="status-message error">上传失败: ${data.message}</p>`;
                }
            })
            .catch(error => {
                console.error('上传错误:', error);
                statusDiv.innerHTML = `<p class="status-message error">上传出错: ${error.message}</p>`;
            });
        });

        // 轮询后端结果接口
        function startPollingResult(filename) {
            const resultStatus = document.getElementById('result-status');
            const resultContent = document.getElementById('result-content');
            const start = Date.now();
            const timeoutMs = 120000; // 最多等待120秒
            resultStatus.innerHTML = '<p class="status-message loading">后台正在处理，请稍候...</p>';

            const timer = setInterval(() => {
                fetch(`/result?filename=${encodeURIComponent(filename)}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success && data.ready) {
                            clearInterval(timer);
                            resultStatus.innerHTML = '<p class="status-message success">结果已生成</p>';
                            resultContent.textContent = data.content || '';
                        } else if (!data.success) {
                            clearInterval(timer);
                            resultStatus.innerHTML = `<p class="status-message error">查询结果失败: ${data.message}</p>`;
                        } else {
                            // 未就绪，继续等待，显示轻微提示
                            const elapsed = Math.floor((Date.now() - start) / 1000);
                            resultStatus.innerHTML = `<p class="status-message loading">后台处理中（${elapsed}s）...</p>`;
                            if (Date.now() - start > timeoutMs) {
                                clearInterval(timer);
                                resultStatus.innerHTML = '<p class="status-message error">等待超时：结果未生成</p>';
                            }
                        }
                    })
                    .catch(err => {
                        clearInterval(timer);
                        console.error('查询结果错误:', err);
                        resultStatus.innerHTML = `<p class="status-message error">查询结果出错: ${err.message}</p>`;
                    });
            }, 2000);
        }
    </script>
</body>
</html>